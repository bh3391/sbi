generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String  @id @default(cuid())
  name           String?
  nickname       String?
  email          String? @unique
  password       String?
  image          String?
  role           Role    @default(TEACHER)
  specialization String?

  qrCodeId           String?             @unique @default(uuid())
  homebaseId         String?
  accounts           Account[]
  teachingLogs       AttendanceLog[]     @relation("TeacherLogs")
  sessions           Session[]
  homebase           Location?           @relation(fields: [homebaseId], references: [id])
  teacherAttendances TeacherAttendance[]
  inventoryLogs      InventoryLog[]
  paymentsCreated    Payment[]           @relation("PaymentCreator")
  paymentsVerified   Payment[]           @relation("PaymentVerifier")
  schedules Schedule[]
}

model Location {
  id        String    @id @default(cuid())
  name      String
  address   String?
  rooms     Room[]
  latitude  Float?
  longitude Float?
  radius    Int       @default(1000)
  students  Student[]
  users     User[]
}

model Room {
  id         String   @id @default(cuid())
  name       String
  locationId String
  location   Location @relation(fields: [locationId], references: [id])
  schedules  Schedule[]
}

model Student {
  id            String  @id @default(cuid())
  fullName      String
  nickname      String
  parentContact String?
  parentName    String? // Kolom Baru

  imageProfile  String?
  status        StudentStatus   @default(NEWSTUDENT)
  qrCodeId      String          @unique @default(uuid())
  packageId     String? // Ubah dari packageType ke Relasi ID
  package       Package?        @relation(fields: [packageId], references: [id])
  subjectId     String? // Ubah dari packageType ke Relasi ID
  subject       Subject?        @relation(fields: [subjectId], references: [id])
  remainingSesi Int             @default(0)
  locationId    String
  attendances   AttendanceLog[]
  location      Location        @relation(fields: [locationId], references: [id])
  payments      Payment[]
  schedules Schedule[]
}
model Schedule {
  id        String   @id @default(cuid())
  day       String   // Senin, Selasa, Rabu, dsb.
  
  // Relasi ke Ruangan
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  // Relasi ke Guru (User)
  teacherId String
  teacher   User     @relation(fields: [teacherId], references: [id])

  // Relasi ke Sesi (Waktu)
  sessionId String
  session   StudentSession @relation(fields: [sessionId], references: [id])

  // Relasi ke Siswa (Banyak siswa dalam satu jadwal/kelas)
  students  Student[]

  subject   Subject  @relation(fields: [subjectId], references: [id])
  subjectId String   // <-- Pastikan field ini ada di schema

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([roomId])
  @@index([teacherId])
  @@index([day])
}
// Tambahan Tabel Subject agar dinamis (Bisa diatur di Dashboard Admin)
model Subject {
  id          String          @id @default(cuid())
  name        String          @unique // Contoh: Matematika, English
  students    Student[]
  attendances AttendanceLog[]
  schedules Schedule[]
}

// Tambahan Tabel StudentSession agar waktu sesi tidak manual ketik
model StudentSession {
  id          String          @id @default(cuid())
  name        String // Contoh: Sesi 1, Sesi Pagi
  startTime   String // Contoh: "08:00"
  endTime     String // Contoh: "10:00"
  attendances AttendanceLog[]
  schedules Schedule[]
}

model AttendanceLog {
  id            String           @id @default(cuid())
  date          DateTime         @default(now())
  status        AttendanceStatus
  processStatus ProcessStatus    @default(LISTED)
  // Scoring & Materi
  score         String? // A, A-, B+, dll
  materi        String?
  evaluation    String?

  // Relasi Siswa & Guru
  studentId String
  teacherId String
  student   Student @relation(fields: [studentId], references: [id])
  teacher   User    @relation("TeacherLogs", fields: [teacherId], references: [id])

  // Relasi ke Subject & Session baru
  subjectId String?
  subject   Subject?        @relation(fields: [subjectId], references: [id])
  sessionId String?
  session   StudentSession? @relation(fields: [sessionId], references: [id])

  // Logika Reschedule
  isRescheduled  Boolean   @default(false)
  rescheduleDate DateTime? // Diisi jika status IZIN/SAKIT

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model TeacherAttendance {
  id        String @id @default(cuid())
  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id])

  date     DateTime       @default(now())
  checkIn  DateTime       @default(now())
  checkOut DateTime?
  type     AttendanceType @default(HADIR)
  status   String // "ON_TIME", "LATE", "LEAVE"
  location String? // Nama lokasi atau koordinat
  notes    String? // Untuk alasan izin/sakit

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teacherId])
}

model Payment {
  id String @id @default(cuid())

  // Relasi ke Siswa
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Detail Pembayaran
  amount Float // Nilai tagihan
  date   DateTime @default(now())

  month Int? // 1-12 (Untuk filter laporan bulanan)
  year  Int? // 2026, dsb.

  // Status & Identifikasi
  status   PaymentStatus @default(PENDING)
  category String?       @default("REGISTRATION") // REGISTRATION, TUITION, dsb.
  notes    String? // Akan diisi "NEWSTUDENT" otomatis dari Server Action

  // Audit Trail (Tanpa Proof Image)
  method      String? // Transfer, Cash, atau VA
  verifiedAt  DateTime? // Kapan admin menekan tombol "Confirm"
  createdById String?
  createdBy   User?     @relation("PaymentCreator", fields: [createdById], references: [id])

  // Admin yang memverifikasi (Confirm)
  verifiedById String?
  verifiedBy   User?   @relation("PaymentVerifier", fields: [verifiedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@index([status])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Package {
  id          String    @id @default(cuid())
  name        String // Contoh: "Paket 12 Sesi"
  price       Float
  description Json // Menyimpan list keuntungan paket dalam format JSON
  sesiCredit  Int // Jumlah sesi yang didapat (misal: 12)
  students    Student[] // Relasi ke siswa yang mengambil paket ini
}

model Inventory {
  id         String @id @default(cuid())
  locationId String
  name       String
  stock      Int    @default(0)

  logs      InventoryLog[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([locationId])
}

model InventoryLog {
  id          String    @id @default(cuid())
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  type     String // "IN" (Tambah) atau "OUT" (Kurang)
  quantity Int
  notes    String?

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
}

enum Role {
  ADMIN
  MANAGEMENT
  TEACHER
}

enum AttendanceStatus {
  HADIR
  IZIN
  SAKIT
  ALPA
}

enum ProcessStatus {
  LISTED
  SCHEDULED
  DONE
}

enum AttendanceType {
  HADIR
  IZIN
  SAKIT
  CUTI
}

enum StudentStatus {
  NEWSTUDENT
  ACTIVE
  INACTIVE
  SUSPEND
  UNPAID
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}
